<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <template id="staffledger" name="Staff Ledger">
            <t t-call="website.layout">
                <head>
                    <meta name="apple-mobile-web-app-capable" content="yes" />
                    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
                    <meta name="apple-mobile-web-app-title" content="StaffLedger" />
                </head>
                <nav class="navbar bg-primary">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <h1 class="navbar-brand mb-0">Time Report</h1>
                        </div>
                    </div>
                </nav>
                <div class="container">
                    <div id="wrap" class="oe_structure oe_empty text-center">
                        <p t-if="employee.attendance_state == 'checked_out'">
                            <h2>
                                <i class="fa fa-user fa-1x" style="color: #f00;" />
                                <span t-esc="employee.name" />
                            </h2>
                            Senast utcheckad:
                            <span t-if="attendance" t-esc="attendance.check_out" />
                        </p>
                        <p t-if="employee.attendance_state == 'checked_in'">
                            <h1>
                                <i class="fa fa-user fa-1x" style="color: #0f0;" />
                                <span t-esc="employee.name" />
                            </h1>
                            Senast incheckad:
                            <span t-if="attendance" t-esc="attendance.check_in" />
                        </p>
                        <div align="center">
                            <div id="mapholder" />
                            <script t-att-src="'https://maps.google.com/maps/api/js?key=%s' % request.env['ir.config_parameter'].get_param('hr_staff_ledger.googlemapkey')" />
                            <br />
                            <form action="/staffledger" method="post" enctype="multipart/form-data">
                                <input id="latitude_in" name="latitude_in" value="" type="hidden" />
                                <input id="longitude_in" name="longitude_in" value="" type="hidden" />
                                <input id="device" name="device" value="" type="hidden" />
                                <t t-if="employee.attendance_state == 'checked_out'">
                                    <t t-if="len(employee.location_ids) &gt; 1">
                                        <select name="location" id="locationSelect" class="form-control" style="width: 240px;">
                                            <t t-foreach="employee.location_ids" t-as="location">
                                                <option t-att-value="location.id" t-esc="location.name" />
                                            </t>
                                        </select>
                                    </t>
                                    <t t-if="len(employee.location_ids) == 1">
                                        <input name="location" t-att-value="employee.location_ids[0].id" type="hidden" />
                                    </t>
                                    <t t-if="len(employee.location_ids) == 0">
                                        <input name="location" t-att-value="default_location.id" type="hidden" />
                                    </t>
                                    <br />
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
                                    <div class="btn-group" role="group" aria-label="...">
                                        <button type="submit" name="sign" value="in" class="btn btn-success btn-md center-block" style="margin-top: 7px;">
                                            <i class="fa fa-sign-in" aria-hidden="true" />
                                            CHECKA IN
                                        </button>
                                        <button type="button" class="btn btn-info btn-md center-block disabled" style="margin-top: 7px;">Personalliggare</button>
                                    </div>
                                </t>
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
                                <t t-if="employee.attendance_state == 'checked_in'">
                                    Incheckad på:
                                    <span t-esc="location and location.name" />
                                    <br />
                                    <div class="btn-group" role="group">
                                        <button type="submit" name="sign" value="out" class="btn btn-danger btn-md center-block" style="margin-top: 7px;">
                                            <i class="fa fa-sign-out" aria-hidden="true" />
                                            CHECKA UT
                                        </button>
                                        <button type="submit" formaction="/staffledger/staffledgerlist" name="btn_staffledger" class="btn btn-info btn-md center-block" style="margin-top: 7px;">Personalliggare</button>
                                    </div>
                                </t>
                            </form>
                        </div>
                    </div>
                </div>
            </t>
        </template>
        <template id="assets_frontend_override" inherit_id="website.assets_frontend">
            <xpath expr="." position="inside">
                <script type="text/javascript" src="/hr_staff_ledger/static/src/js/main.js" />
            </xpath>
        </template>
        <template id="staffledgerlist" name="Staff Ledger List">
            <t t-call="website.layout">
                <div id="wrap" class="oe_structure oe_empty">
                    <nav class="navbar bg-primary">
                        <div class="container-fluid">
                            <div class="navbar-header">
                                <span class="navbar-brand mb-0 h1">Personalliggare</span>
                            </div>
                        </div>
                    </nav>
                    <t t-call="hr_staff_ledger.staffledger_list">
                        <a href="/staffledger/" class="btn btn-info btn-sm">
                            <i class="fa fa-arrow-circle-left " aria-hidden="true" />
                            Back
                        </a>
                        <a  t-att-href="'/staffledger/mail_staffledger/%s' % location.id" name="btn_mail_staffledger" class="btn btn-warning btn-sm">
                            <i class="fa fa-envelope " aria-hidden="true" />
                            E-mail
                        </a>
                        <br />
                        <br />
                    </t>
                </div>
            </t>
        </template>
        <template id="report_staffledger_document">
            <t t-call="report.external_layout">
                <t t-set="location" t-value="doc" />
                <div class="page">
                    <t t-call="hr_staff_ledger.staffledger_list" />
                </div>
            </t>
        </template>
        <template id="staffledger_list">
            <div class="container">
                <t t-raw="0" />
                <div class="text-center">
                    <h3>
                        <b>
                            <span t-esc="location and location.name" />
                        </b>
                    </h3>
                    <h5>
                        <b>Skatteverkets ID:</b>
                        <span t-esc="location and location.idnumber" />
                        <br />
                        <b>Utskriftsdatum:</b>
                        <span t-esc="time.strftime('%%Y-%%m-%%d %%H:%%M:%%S')" />
                    </h5>
                </div>
                <br />
                <t t-set="transaction" t-value="request.env['hr.staff.ledger.transaction'].search([('location_id', '=' , location.id), ('date_in', '&gt;=', time.strftime('%%Y-%%m-%%d 00:00:00')), ('date_in', '&lt;=', time.strftime('%%Y-%%m-%%d 23:59:59'))])" />
                <t t-foreach="transaction" t-as="trans">
                    <h5>
                        <b>
                            <span t-field="trans.employee_id" />
                            (
                            <span t-field="trans.identification_id" />
                            )
                        </b>
                    </h5>
                    <h6>
                        <b>
                            <span t-field="trans.address_id" />
                            (
                            <span t-field="trans.company_registry" />
                            )
                        </b>
                        <br />
                        Check in:
                        <span t-field="trans.date_in" />
                        <br />
                        Check ut:
                        <span t-field="trans.date_out" />
                    </h6>
                    <hr />
                </t>
            </div>
        </template>
        <template id="timereportlist">
            <t t-call="website.layout" />
        </template>
        <record id="view_staff_ledger_transaction_form" model="ir.ui.view">
            <field name="name">hr.staff.ledger.transaction.form</field>
            <field name="model">hr.staff.ledger.transaction</field>
            <field name="arch" type="xml">
                <form string="Employee">
                    <sheet>
                        <div class="oe_button_box" name="button_box" />
                        <group>
                            <group>
                                <field name="status" widget="hr_attendance_form_presence_indicator" />
                                <field name="employee_id" />
                                <field name="identification_id" />
                                <field name="address_id" />
                                <field name="company_registry" />
                            </group>
                            <group>
                                <field name="date" />
                                <field name="date_in" />
                                <field name="date_out" />
                                <field name="location_id" />
                                <field name="idnumber" />
                                <field name="longitude" />
                                <field name="latitude" />
                                <label for="distance" />
                                <span>
                                    <field name="distance" />
                                    Meter
                                </span>
                            </group>
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers" groups="base.group_user" />
                        <field name="message_ids" widget="mail_thread" />
                    </div>
                </form>
            </field>
        </record>
        <record id="view_staff_ledger_transaction_filter" model="ir.ui.view">
            <field name="name">hr.staff.ledger.transaction.search</field>
            <field name="model">hr.staff.ledger.transaction</field>
            <field name="arch" type="xml">
                <search string="Staff ledger">
                    <field name="date" />
                    <field name="location_id" />
                    <field name="status" />
                    <filter string="Current Staff ledger" name="current_staffledger" domain="[('status', '=', 'checked_in')]" />
                    <filter string="Today" name="date_today" domain="[('date', '&gt;=', time.strftime('%%Y-%%m-%%d 00:00:00')), ('date', '&lt;=', time.strftime('%%Y-%%m-%%d 23:59:59'))]" />
                    <filter string="This Month" name="date_month" domain="[('date', '&gt;=', time.strftime('%%Y-%%m-01 00:00:00')), ('date', '&lt;=', time.strftime('%%Y-%%m-%%d 23:59:59'))]" />
                    <filter string="This Year" name="date_year" domain="[('date', '&gt;=', time.strftime('%%Y-01-01 00:00:00')), ('date', '&lt;=', time.strftime('%%Y-12-31 23:59:59'))]" />
                    <group expand="0" string="Group By">
                        <filter string="Date" domain="[]" context="{'group_by':'date'}" />
                        <filter string="Location Id" domain="[]" context="{'group_by':'location_id'}" />
                        <filter string="Status" domain="[]" context="{'group_by':'status'}" />
                    </group>
                </search>
            </field>
        </record>
        <record id="view_staff_ledger_transaction_calendar" model="ir.ui.view">
            <field name="name">staff.ledger.transaction.calendar</field>
            <field name="model">hr.staff.ledger.transaction</field>
            <field name="priority" eval="2" />
            <field name="arch" type="xml">
                <calendar string="Staff Ledger Calendar" date_start="date_in" date_stop="date_out" mode="month" color="employee_id">
                    <field name="employee_id" />
                    <field name="location_id" />
                </calendar>
            </field>
        </record>
        <record id="view_staff_ledger_transaction_tree" model="ir.ui.view">
            <field name="name">hr.staff.ledger.transaction.tree</field>
            <field name="model">hr.staff.ledger.transaction</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Staff ledger transaction" colors="red:status=='checked_out';green:status=='checked_in'">
                    <field name="date" />
                    <field name="address_id" />
                    <field name="company_registry" />
                    <field name="location_id" />
                    <field name="idnumber" />
                    <field name="employee_id" />
                    <field name="identification_id" />
                    <field name="date_in" />
                    <field name="date_out" />
                    <field name="status" invisible="1" />
                </tree>
            </field>
        </record>
        <record id="view_staff_ledger_location_tree" model="ir.ui.view">
            <field name="name">hr.staff.ledger.location.tree</field>
            <field name="model">hr.staff.ledger.location</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Staff ledger location">
                    <field name="name" />
                    <field name="default_location" />
                </tree>
            </field>
        </record>
        <record id="view_staff_ledger_location_form" model="ir.ui.view">
            <field name="name">hr.staff.ledger.location.form</field>
            <field name="model">hr.staff.ledger.location</field>
            <field name="arch" type="xml">
                <form string="Employee">
                    <sheet>
                        <button name="action_report_send" string="Email Staff Ledger" type="object" />
                        <div class="oe_button_box" name="button_box" />
                        <group>
                            <group>
                                <field name="name" />
                                <field name="street" />
                                <field name="street2" />
                                <field name="zip" />
                                <field name="city" />
                                <field name="country_id" />
                            </group>
                            <group>
                                <field name="registered" />
                                <field name="idnumber" />
                                <field name="longitude" />
                                <field name="latitude" />
                                <field name="comment" />
                                <field name="default_location" />
                            </group>
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers" groups="base.group_user" />
                        <field name="message_ids" widget="mail_thread" />
                    </div>
                </form>
            </field>
        </record>
        <act_window context="{}" id="staff_ledger_action" name="Staff Ledger Transactions" view_type="form" view_mode="tree,form,calendar" res_model="hr.staff.ledger.transaction" target="current" view_id="hr_staff_ledger.view_staff_ledger_transaction_tree" />
        <menuitem id="staffledger_menu" name="Staff Ledger" parent="hr_attendance.menu_hr_attendance_manage_attendances" sequence="25" action="hr_staff_ledger.staff_ledger_action" />
        <act_window context="{}" id="staff_ledger_location_action" name="Locations" view_type="form" view_mode="tree,form" res_model="hr.staff.ledger.location" target="current" view_id="hr_staff_ledger.view_staff_ledger_location_tree" />
        <menuitem id="staffledger_location_menu" name="Locations" parent="hr_attendance.menu_hr_attendance_settings" sequence="10" action="hr_staff_ledger.staff_ledger_location_action" />
        <record id="view_employee_form" model="ir.ui.view">
            <field name="name">hr.employee.form.location</field>
            <field name="model">hr.employee</field>
            <field name="inherit_id" ref="hr.view_employee_form" />
            <field name="arch" type="xml">
                <field name="calendar_id" position="after">
                    <field name="location_ids" widget="many2many_tags" />
                </field>
            </field>
        </record>
        <report id="report_staff_ledger_list" string="Staff Ledger" model="hr.staff.ledger.location" report_type="qweb-pdf" file="hr_staff_ledger.report_staffledger" name="hr_staff_ledger.report_staffledger" />
        <template id="report_staffledger">
            <t t-call="report.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-call="hr_staff_ledger.report_staffledger_document" t-lang="user.lang" />
                    <!--
                         t-lang="doc.partner_id.lang"
                    -->
                </t>
            </t>
        </template>
        <template id="mail_staffledger" name="Mail Staff Ledger">
            <t t-call="website.layout">
                <nav class="navbar bg-primary">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <h1 class="navbar-brand mb-0">Mail Staff Ledger</h1>
                        </div>
                    </div>
                </nav>
                <div class="container">
                    <a href="/staffledger/staffledgerlist" class="btn btn-info btn-sm">
                        <i class="fa fa-arrow-circle-left " aria-hidden="true" />
                        Back
                    </a>
                    <br />
                    <br />
                    <div align="center">
                        <p>
                            <h5>Här kan du skicka personalliggaren med e-post till någon på Skatteverket.</h5>
                        </p>
                        <form t-att-action="'/staffledger/mail_staffledger/%s' % location.id" method="post">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
                            <input type="email" name="email" value="@skatteverket.se" class="form-control" style="width: 240px;" required="" />
                            <br />
                            <br />
                            <button type="submit" name="btn_send_mail_staffledger" class="btn btn-info btn-md center-block">
                                <i class="fa fa-send" aria-hidden="true" />
                                Send
                            </button>
                        </form>
                    </div>
                </div>
            </t>
        </template>
        <record id="mail_template_staff_ledger" model="mail.template">
            <field name="name">Staff Ledger email</field>
            <!--
                 <field name="email_from">${(object.user_id.email and '%s &lt;%s&gt;' % (object.user_id.name, object.user_id.email) or '')|safe}</field>
            -->
            <field name="email_from" />
            <field name="subject">Staff Ledger for ${object.name}</field>
            <field name="partner_to" />
            <field name="model_id" ref="hr_staff_ledger.model_hr_staff_ledger_location" />
            <field name="auto_delete" eval="True" />
            <field name="report_template" ref="report_staff_ledger_list" />
            <field name="report_name">${'%s %s' % ((object.name or ''), datetime.datetime.now().strftime('%Y-%m-%d %H:%M'))}</field>
            <field name="lang" />
            <field name="body_html">
                <![CDATA[
                        Hej!


						Här kommer personalliggaren för ${object.name}.
                        


						Mvh

						${user.company_name}
						${user.name}
						${user.phone}
                ]]>
            </field>
            <!--
                 <field name="body_html">
                 <![CDATA[
                 
                 <p>Dear ${object.partner_id.name}
                 % set access_action = object.with_context(force_website=True).get_access_action()
                 % set doc_name = 'quotation' if object.state in ('draft', 'sent') else 'order confirmation'
                 % set is_online = access_action and access_action['type'] == 'ir.actions.act_url'
                 % set access_name = is_online and object.template_id and doc_name == 'quotation' and 'Accept and pay %s online' % doc_name or 'View %s' % doc_name
                 % set access_url = is_online and access_action['url'] or None
                 
                 % if object.partner_id.parent_id:
                 (<i>${object.partner_id.parent_id.name}</i>)
                 % endif
                 ,</p>
                 <p>
                 Here is your ${doc_name} <strong>${object.name}</strong>
                 % if object.origin:
                 (with reference: ${object.origin} )
                 % endif
                 amounting in <strong>${object.amount_total} ${object.pricelist_id.currency_id.name}</strong>
                 from ${object.company_id.name}.
                 </p>
                 
                 <br/><br/>
                 % if is_online:
                 <center>
                 <a href="${access_url}" style="background-color: #1abc9c; padding: 20px; text-decoration: none; color: #fff; border-radius: 5px; font-size: 16px;" class="o_default_snippet_text">${access_name}</a>
                 <br/><br/>
                 <span style="color:#888888">(or view attached PDF)</span>
                 </center>
                 <br/>
                 % endif
                 
                 <p>You can reply to this email if you have any questions.</p>
                 <p>Thank you,</p>
                 
                 <p style="color:#eeeeee;">
                 % if object.user_id and object.user_id.signature:
                 ${object.user_id.signature | safe}
                 % endif
                 </p>
                 ]]>
                 </field>
            -->
        </record>
    </data>
</openerp>
